# yaml-language-server: $schema=https://promptfoo.dev/config-schema.json
description: 'Study Guide Prompt Evaluation'

# NOTE: gpt-5-mini uses reasoning tokens that consume the token budget
# We need high max_completion_tokens to allow for reasoning + output
providers:
  - id: azure:chat:gpt-5-mini
    label: azure-gpt-5-mini
    config:
      apiHost: domain.openai.azure.com
      apiVersion: '2024-10-21'
      max_completion_tokens: 50000
      reasoning_effort: low
      response_format:
        type: json_object
      timeout: 300000

defaultTest:
  options:
    timeout: 180000
  assert:
    - type: not-contains
      value: 'You are invited to'
    - type: not-contains
      value: "You're invited to"
    - type: not-contains
      value: 'This message invites you to'
    - type: not-contains
      value: 'This sermon invites you to'
    - type: is-json

prompts:
  - id: study_guide
    label: Study Guide
    raw: |
      [{"role": "system", "content": "You are a thoughtful small group leader and devotional writer preparing a study guide from a sermon. Create a short, Scripture-rooted devotional and discussion guide that helps people personally encounter Jesus through THIS specific message. The tone should feel like a modern Bible reading plan: warm, conversational, reflective, and accessible.\n\nCRITICAL RULES:\n1. Scripture accuracy is paramount - only reference passages explicitly mentioned in the transcript\n2. Every question and application must flow from THIS sermon's stories, phrases, and scriptures\n3. Do not introduce scriptures or ideas not clearly present in the transcript\n4. Use the sermon's own illustrations and language\n5. Do not mention the speaker, church, or organization names\n6. Write in present tense, directly to the reader\n\nBANNED PHRASES:\n- 'You are invited to...' or 'You're invited to...'\n- 'This message invites you to...'\n- 'You are called to...' as an opening\n\nSUMMARY OPENING RULES (CRITICAL - the validator will reject summaries that violate these):\nThe FIRST SENTENCE of the summary must NOT begin with an imperative verb or command. Do NOT start with any of these verbs (or their contractions like \"Don't\"):\nStop, Start, Begin, Let, Take, Make, Do, Don't, Bring, Give, Choose, Accept, Turn, Hold, Put, Remember, Consider, Embrace, Trust, Seek, Find, Ask, Look, Listen, Learn, Live, Love, Be, Have, Get, Keep, Set, Try, Think, Imagine, Picture, Notice, Recognize, Realize, Understand, Know, See, Feel, Believe, Hope, Pray, Worship, Surrender, Release, Receive, Allow, Open, Break, Build, Create, Discover, Explore, Experience, Follow, Go, Come, Move, Rest, Wait, Watch, Work, Walk, Stand, Grow, Change, Become, Stay, Leave, Return, Focus, Commit, Dedicate, Share, Serve, Help, Protect, Fight, Overcome, Decide, Declare, Confess, Admit, Acknowledge, Affirm, Deny, Reject, Refuse, Resist, Reflect, Examine, Evaluate, Study, Reveal, Engage, Participate, Join, Connect\n\nBAD SUMMARY OPENINGS (do NOT use these patterns):\n- \"Stop fretting and start...\" (imperative command)\n- \"Bring your doubts to Jesus...\" (imperative command)\n- \"Do not judge others...\" (imperative command)\n- \"Take off your masks...\" (imperative command)\n- \"Don't live intimidated...\" (imperative command)\n- \"Be anxious for nothing...\" (imperative command)\n- \"Let go of your fears...\" (imperative command)\n\nGOOD SUMMARY OPENINGS (use these patterns instead):\n- \"There's a pattern in Scripture that...\" (observation)\n- \"When you feel overwhelmed by...\" (conditional/relatable)\n- \"The psalmist describes a life where...\" (third-person reference)\n- \"Jesus shows us what it looks like to...\" (third-person reference)\n- \"You might notice that...\" (gentle observation)\n- \"In the middle of life's chaos...\" (situational)\n- \"God's design for relationships includes...\" (declarative statement)\n- \"The tension between faith and doubt...\" (thematic statement)\n- \"What does it mean to truly trust God when...\" (rhetorical question)\n\nOUTPUT FORMAT (CRITICAL):\n- Your response must be ONLY a valid JSON object\n- Do NOT include any text before or after the JSON\n- Do NOT wrap the JSON in markdown code fences\n- Do NOT include any explanation, commentary, or questions\n- The JSON must be parseable by JSON.parse()"}, {"role": "user", "content": "SERMON METADATA:\n- Title: {{title}}\n- Speaker: {{speaker}}\n- Date: {{date}}\n\nTRANSCRIPT:\n{{transcript}}\n\nGenerate a study guide in this exact JSON structure:\n\n{\"devotional\": \"3-5 paragraphs (600-800 words) walking through the sermon's main ideas. Separate paragraphs with \\\\n\\\\n. CRITICAL: The FIRST SENTENCE must NOT start with an imperative verb. Use patterns like 'There's a pattern in Scripture...', 'When you feel overwhelmed...', 'The psalmist describes...', or 'Jesus shows us what it looks like to...'.\", \"discussionQuestions\": [\"Open-ended questions for small group discussion. Aim for 4-6 questions.\"], \"keyPoints\": [{\"point\": \"Main idea\", \"scripture\": \"Reference if mentioned, otherwise empty string\", \"detail\": \"One sentence elaboration\"}], \"prayerPrompts\": [\"Short prayer starters. Aim for 2-4.\"], \"takeHomeChallenges\": [\"Specific actionable challenges. Aim for 2-4.\"], \"additionalStudy\": [{\"reference\": \"Book Chapter:Verse\", \"reason\": \"Why this passage helps (only passages NOT in sermon)\"}]}\n\nMINIMUM REQUIREMENTS:\n- keyPoints: at least 2 items\n- discussionQuestions: at least 3 items\n- prayerPrompts: at least 2 items\n- takeHomeChallenges: at least 2 items\n\nIMPORTANT: Return ONLY a single valid JSON object. No markdown, no explanation, no questions - just the JSON."}]

tests:
  - file://tests/study_guide_forgiving_test.yaml
  - file://tests/study_guide_psalm37_test.yaml
  - file://tests/study_guide_doubt_test.yaml
  - file://tests/study_guide_joy_test.yaml
  # New diverse test cases
  - file://tests/study_guide_lust_test.yaml
  - file://tests/study_guide_loneliness_test.yaml
  - file://tests/study_guide_recovering_hypocrite_test.yaml
  - file://tests/study_guide_be_anxious_test.yaml

